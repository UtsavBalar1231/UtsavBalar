---
import { themes } from "../data/themes";
---

<div class="theme-selector">
  <button
    id="theme-selector-btn"
    class="theme-selector-btn"
    aria-label="Select theme"
    aria-expanded="false"
    aria-controls="theme-selector-dropdown"
  >
    <span class="theme-label">Theme:</span>
    <span class="current-theme" id="current-theme-display">Green Phosphor</span>
    <svg
      class="dropdown-icon"
      width="12"
      height="12"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div
    id="theme-selector-dropdown"
    class="theme-dropdown hidden"
    role="menu"
    aria-labelledby="theme-selector-btn"
  >
    {
      themes.map((theme) => (
        <button
          class="theme-option glitch-subtle-hover"
          data-theme={theme.value}
          data-theme-label={theme.label}
          role="menuitem"
          aria-label={`Switch to ${theme.label} theme`}
        >
          <div class="theme-option-content">
            <div class="theme-option-header">
              <span class="theme-indicator" aria-hidden="true" />
              <span class="theme-name">{theme.label}</span>
            </div>
            <div class="color-palette" data-theme-preview={theme.value}>
              <span class="color-dot" data-color="red" title="Red" />
              <span class="color-dot" data-color="green" title="Green" />
              <span class="color-dot" data-color="yellow" title="Yellow" />
              <span class="color-dot" data-color="blue" title="Blue" />
              <span class="color-dot" data-color="magenta" title="Magenta" />
              <span class="color-dot" data-color="cyan" title="Cyan" />
              <span class="color-dot" data-color="white" title="White" />
              <span class="color-dot" data-color="bright" title="Accent" />
            </div>
          </div>
        </button>
      ))
    }
  </div>
</div>

<style>
  .hidden {
    display: none !important;
  }

  .theme-selector {
    position: relative;
    z-index: 45;
  }

  .theme-selector-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(var(--bg-color-rgb), 0.06);
    backdrop-filter: blur(8px) saturate(1.1);
    -webkit-backdrop-filter: blur(8px) saturate(1.1);
    color: var(--text-primary);
    border: 1px solid rgba(var(--border-color-rgb), 0.5);
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: "D2Coding", monospace;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    box-shadow:
      0 2px 8px rgba(0, 0, 0, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.02);
  }

  .theme-selector-btn:hover {
    background: rgba(var(--bg-color-rgb), 0.1);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    border-color: var(--accent-primary);
    box-shadow:
      0 0 10px rgba(var(--accent-primary-rgb), 0.2),
      0 4px 12px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.04);
  }

  .theme-label {
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .current-theme {
    color: var(--accent-primary);
    font-weight: 600;
  }

  .dropdown-icon {
    transition: transform 0.2s ease;
  }

  .theme-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 250px;
    max-width: calc(100vw - 2rem);
    background: rgba(var(--bg-color-rgb), 0.08);
    backdrop-filter: blur(12px) saturate(1.2);
    -webkit-backdrop-filter: blur(12px) saturate(1.2);
    border: 1px solid rgba(var(--border-color-rgb), 0.6);
    border-radius: 0.25rem;
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.15),
      0 2px 8px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.03);
    overflow: hidden;
    z-index: 50;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .theme-option {
    display: block;
    width: 100%;
    padding: 0.75rem 1rem;
    background: transparent;
    color: var(--text-primary);
    border: none;
    font-size: 0.875rem;
    font-family: "D2Coding", monospace;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .theme-option-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .theme-option-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .theme-option:hover {
    background: rgba(var(--bg-color-rgb), 0.06);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
  }

  .theme-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid var(--border-color);
    position: relative;
  }

  .theme-name {
    flex: 1;
  }

  .color-palette {
    display: flex;
    gap: 0.25rem;
    padding-top: 0.25rem;
  }

  .color-dot {
    width: 16px;
    height: 16px;
    border-radius: 2px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.2s ease;
  }

  .color-dot:hover {
    transform: scale(1.2);
  }

  [data-theme-preview="green"] .color-dot[data-color="red"] {
    background-color: #ff0000;
  }
  [data-theme-preview="green"] .color-dot[data-color="green"] {
    background-color: #00ff00;
  }
  [data-theme-preview="green"] .color-dot[data-color="yellow"] {
    background-color: #ffff00;
  }
  [data-theme-preview="green"] .color-dot[data-color="blue"] {
    background-color: #5c5cff;
  }
  [data-theme-preview="green"] .color-dot[data-color="magenta"] {
    background-color: #ff00ff;
  }
  [data-theme-preview="green"] .color-dot[data-color="cyan"] {
    background-color: #00ffff;
  }
  [data-theme-preview="green"] .color-dot[data-color="white"] {
    background-color: #ffffff;
  }
  [data-theme-preview="green"] .color-dot[data-color="bright"] {
    background-color: #00ff00;
  }

  [data-theme-preview="amber"] .color-dot[data-color="red"] {
    background-color: #ff6644;
  }
  [data-theme-preview="amber"] .color-dot[data-color="green"] {
    background-color: #bbff00;
  }
  [data-theme-preview="amber"] .color-dot[data-color="yellow"] {
    background-color: #ffb000;
  }
  [data-theme-preview="amber"] .color-dot[data-color="blue"] {
    background-color: #0099ff;
  }
  [data-theme-preview="amber"] .color-dot[data-color="magenta"] {
    background-color: #ff66cc;
  }
  [data-theme-preview="amber"] .color-dot[data-color="cyan"] {
    background-color: #00ccff;
  }
  [data-theme-preview="amber"] .color-dot[data-color="white"] {
    background-color: #ffffff;
  }
  [data-theme-preview="amber"] .color-dot[data-color="bright"] {
    background-color: #ffb000;
  }

  [data-theme-preview="monochrome"] .color-dot[data-color="red"] {
    background-color: #ff5555;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="green"] {
    background-color: #55ff55;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="yellow"] {
    background-color: #ffff55;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="blue"] {
    background-color: #5555ff;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="magenta"] {
    background-color: #ff55ff;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="cyan"] {
    background-color: #55ffff;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="white"] {
    background-color: #ffffff;
  }
  [data-theme-preview="monochrome"] .color-dot[data-color="bright"] {
    background-color: #ffffff;
  }

  [data-theme-preview="doom"] .color-dot[data-color="red"] {
    background-color: #ff4100;
  }
  [data-theme-preview="doom"] .color-dot[data-color="green"] {
    background-color: #8ae234;
  }
  [data-theme-preview="doom"] .color-dot[data-color="yellow"] {
    background-color: #ff8800;
  }
  [data-theme-preview="doom"] .color-dot[data-color="blue"] {
    background-color: #729fcf;
  }
  [data-theme-preview="doom"] .color-dot[data-color="magenta"] {
    background-color: #ad7fa8;
  }
  [data-theme-preview="doom"] .color-dot[data-color="cyan"] {
    background-color: #34e2e2;
  }
  [data-theme-preview="doom"] .color-dot[data-color="white"] {
    background-color: #eeeeec;
  }
  [data-theme-preview="doom"] .color-dot[data-color="bright"] {
    background-color: #ff4100;
  }

  @media (max-width: 768px) {
    .theme-selector-btn {
      padding: 0.375rem 0.5rem;
      font-size: 0.75rem;
      gap: 0.25rem;
    }

    .theme-label {
      display: none;
    }

    .theme-dropdown {
      min-width: 200px;
      right: 0;
      max-width: calc(100vw - 1rem);
      max-height: calc(100vh - 80px);
    }

    .color-palette {
      display: none;
    }

    .theme-option {
      padding: 0.625rem 0.75rem;
      font-size: 0.8125rem;
    }

    .dropdown-icon {
      width: 10px;
      height: 10px;
    }
  }

  @media (max-width: 375px) {
    .theme-selector-btn {
      padding: 0.25rem 0.375rem;
      font-size: 0.7rem;
    }

    .current-theme {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const themeSelector = document.getElementById("theme-selector-btn");
    const themeDropdown = document.getElementById("theme-selector-dropdown");
    const themeOptions = document.querySelectorAll(".theme-option");
    const currentThemeDisplay = document.getElementById("current-theme-display");

    if (!themeSelector || !themeDropdown) {
      console.error("Theme selector elements not found:", { themeSelector, themeDropdown });
      return;
    }

    const getCurrentTheme = (): string => localStorage.getItem("selectedTheme") || "green";

    const getThemeLabel = (themeValue: string): string => {
      const option = document.querySelector(`.theme-option[data-theme="${themeValue}"]`);
      return option?.getAttribute("data-theme-label") || "Green Phosphor";
    };

    const setTheme = (theme: string): void => {
      document.documentElement.setAttribute("data-theme", theme);
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem("selectedTheme", theme);

      themeOptions.forEach((option) => {
        const isActive = option.getAttribute("data-theme") === theme;
        option.classList.toggle("active", isActive);
      });

      if (currentThemeDisplay) {
        currentThemeDisplay.textContent = getThemeLabel(theme);
      }
    };

    const currentTheme = getCurrentTheme();
    themeOptions.forEach((option) => {
      const isActive = option.getAttribute("data-theme") === currentTheme;
      option.classList.toggle("active", isActive);
    });

    if (currentThemeDisplay) {
      currentThemeDisplay.textContent = getThemeLabel(currentTheme);
    }

    const toggleDropdown = (show?: boolean) => {
      if (show === undefined) {
        themeDropdown.classList.toggle("hidden");
        const isHidden = themeDropdown.classList.contains("hidden");
        themeSelector.setAttribute("aria-expanded", (!isHidden).toString());
      } else if (show) {
        themeDropdown.classList.remove("hidden");
        themeSelector.setAttribute("aria-expanded", "true");
      } else {
        themeDropdown.classList.add("hidden");
        themeSelector.setAttribute("aria-expanded", "false");
      }
    };

    themeSelector.addEventListener("click", (e) => {
      e.stopPropagation();
      e.preventDefault();
      toggleDropdown();
    });

    document.addEventListener("click", (e) => {
      if (
        e.target instanceof Node &&
        !themeSelector.contains(e.target) &&
        !themeDropdown.contains(e.target)
      ) {
        toggleDropdown(false);
      }
    });

    themeOptions.forEach((option) => {
      option.addEventListener("click", (e) => {
        e.stopPropagation();
        const newTheme = option.getAttribute("data-theme");
        if (newTheme) {
          setTheme(newTheme);
          toggleDropdown(false);
        }
      });
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        toggleDropdown(false);
      }
    });
  });
</script>
