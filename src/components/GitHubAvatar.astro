---
// Pass props to determine size
const { width = 96, height = 96, class: className = "", useGithub = false } = Astro.props;

// GitHub username to fetch the avatar for
const username = "UtsavBalar1231";

// Fetch GitHub user data
let avatarUrl = "";
let name = "";

// Generate a random seed for the cat image to avoid caching
const randomSeed = Math.floor(Math.random() * 1000);

// Default to cat image unless explicitly asked for GitHub
if (useGithub) {
  try {
    // GitHub API has rate limits, so let's add a timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    const response = await fetch(`https://api.github.com/users/${username}`, {
      signal: controller.signal,
      headers: {
        Accept: "application/vnd.github.v3+json",
        "User-Agent": "Astro-Portfolio",
      },
    });

    clearTimeout(timeoutId);

    if (response.ok) {
      const userData = await response.json();
      avatarUrl = userData.avatar_url;
      name = userData.name || username;
    } else {
      console.error(`Failed to fetch GitHub user data: ${response.status}`);
    }
  } catch (error) {
    console.error("Error fetching GitHub user data:", error);
  }
} else {
  // Get a random cat image by default with more reliable API
  // avatarUrl = `https://api.dicebear.com/7.x/shapes/svg?seed=${randomSeed}&backgroundColor=b6e3f4,c0aede,d1d4f9&shape1Color=0a5b83,1c799f,69d2e7&shape2Color=0a5b83,1c799f,69d2e7&shape3Color=0a5b83,1c799f,69d2e7`;
  avatarUrl = `https://cataas.com/cat/funny?width=${width}&height=${height}&s=${randomSeed}`;
  name = "Random Cat";
}

// Default avatar if all fetches fail
const defaultAvatar = "/img/default-avatar.svg";
---

<div class:list={`avatar-container ${className}`} style="width: 5rem; height: 5rem;">
  {/* eslint-disable-next-line astro/jsx-a11y/no-noninteractive-element-interactions */}
  <img
    src={avatarUrl || defaultAvatar}
    alt={name ? `${name}'s avatar` : "Profile avatar"}
    title={name || "Profile avatar"}
    loading="eager"
    id="profile-avatar"
    class="avatar-img clickable-avatar"
    onerror="this.onerror=null; this.src='/img/default-avatar.svg';"
  />
</div>

<style>
  .avatar-container {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    aspect-ratio: 1 / 1;
  }

  /* Responsive sizing using media queries */
  @media (min-width: 640px) {
    .avatar-container {
      width: 6.25rem !important;
      height: 6.25rem !important;
    }
  }

  @media (min-width: 768px) {
    .avatar-container {
      width: 6rem !important;
      height: 6rem !important;
    }
  }

  .avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .clickable-avatar {
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .clickable-avatar:hover {
    transform: scale(1.05);
  }
</style>

<script>
  // Add function to refresh cat image that will be called by the refresh button
  window.refreshCatImage = () => {
    const avatarEl = document.getElementById("profile-avatar") as HTMLImageElement;
    if (avatarEl) {
      const random = Math.floor(Math.random() * 1000);
      // Get dimensions from parent container if available
      const container = avatarEl.closest(".avatar-container");
      const width = container ? container.clientWidth : avatarEl.getAttribute("width");
      const height = container ? container.clientHeight : avatarEl.getAttribute("height");
      avatarEl.src = `https://cataas.com/cat?width=${width}&height=${height}&s=${random}`;
    }
  };

  // Add click handler for spinning cat meme
  document.addEventListener("DOMContentLoaded", () => {
    const avatarEl = document.getElementById("profile-avatar");

    if (avatarEl) {
      avatarEl.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Check if already played in this session
        if (!sessionStorage.getItem("catPlayed")) {
          // Set flag to prevent playing again
          sessionStorage.setItem("catPlayed", "true");

          // Dispatch custom event to start the spinning cat
          window.dispatchEvent(new CustomEvent("startSpinningCat"));
        }
      });
    }
  });
</script>
