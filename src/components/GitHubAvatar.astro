---
import { API } from "../config/constants";
import { profile } from "@data/profile";

const { width = 96, height = 96, class: className = "", useGithub = false } = Astro.props;

const username = profile.github;

let avatarUrl = "";
let name = "";

const randomSeed = Math.floor(Math.random() * 1000);

if (useGithub) {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), API.GITHUB_TIMEOUT);

    const response = await fetch(`${API.GITHUB_USER}${username}`, {
      signal: controller.signal,
      headers: {
        Accept: "application/vnd.github.v3+json",
        "User-Agent": "Astro-Portfolio",
      },
    });

    clearTimeout(timeoutId);

    if (response.ok) {
      const userData = await response.json();
      avatarUrl = userData.avatar_url;
      name = userData.name || username;
    }
  } catch (error) {
    console.warn("Failed to fetch GitHub avatar:", error);
  }
} else {
  avatarUrl = `https://cataas.com/cat/funny?width=${width}&height=${height}&s=${randomSeed}`;
  name = "Random Cat";
}

const defaultAvatar = "/img/default-avatar.svg";
---

<div class:list={`avatar-container ${className}`}>
  {/* eslint-disable-next-line astro/jsx-a11y/no-noninteractive-element-interactions */}
  <img
    src={avatarUrl || defaultAvatar}
    alt={name ? `${name}'s avatar` : "Profile avatar"}
    title={name || "Profile avatar"}
    loading="lazy"
    decoding="async"
    id="profile-avatar"
    class="avatar-img clickable-avatar"
    onerror="this.onerror=null; this.src='/img/default-avatar.svg';"
  />
</div>

<style>
  .avatar-container {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    aspect-ratio: 1 / 1;
    width: 5rem;
    height: 5rem;
  }

  @media (min-width: 640px) {
    .avatar-container {
      width: 6.25rem !important;
      height: 6.25rem !important;
    }
  }

  @media (min-width: 768px) {
    .avatar-container {
      width: 6rem !important;
      height: 6rem !important;
    }
  }

  .avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .clickable-avatar {
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .clickable-avatar:hover {
    transform: scale(1.05);
  }
</style>

<script>
  window.refreshCatImage = () => {
    const avatarEl = document.getElementById("profile-avatar") as HTMLImageElement;
    if (avatarEl) {
      const random = Math.floor(Math.random() * 1000);
      const container = avatarEl.closest(".avatar-container");
      const width = container ? container.clientWidth : avatarEl.getAttribute("width");
      const height = container ? container.clientHeight : avatarEl.getAttribute("height");
      avatarEl.src = `https://cataas.com/cat?width=${width}&height=${height}&s=${random}`;
    }
  };

  document.addEventListener("DOMContentLoaded", () => {
    const avatarEl = document.getElementById("profile-avatar");

    if (avatarEl) {
      avatarEl.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        window.dispatchEvent(new CustomEvent("startSpinningCat"));
      });
    }
  });
</script>
