---
import WebGLFallback from "@components/WebGLFallback.astro";
---

<canvas id="sakura-fall-canvas" class="sakura-fall-canvas"></canvas>
<WebGLFallback show={false} />

<style>
  .sakura-fall-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    touch-action: none;
    opacity: 0.4;
    mix-blend-mode: screen;
    contain: strict;
    contain-intrinsic-size: 100vw 100vh;
  }
</style>

<script>
  import { WebGLSakuraFall } from "@/utils/webglSakura";
  import { getRecommendedFPS } from "@/utils/deviceDetection";
  import { hasTargetFPS, hasIsRunning, hasStartMethod, hasStopMethod } from "@/types/webglEffect";
  import { setupEffectLifecycle } from "@/utils/visualEffectLifecycle";

  const effectRef = { current: null as WebGLSakuraFall | null };
  let webgl2Unsupported = false;

  function shouldInitialize(): boolean {
    const theme = document.documentElement.getAttribute("data-theme");
    return theme === "monochrome";
  }

  function initSakuraFall() {
    if (shouldInitialize() && !effectRef.current && !webgl2Unsupported) {
      const recommendedFPS = getRecommendedFPS();

      effectRef.current = new WebGLSakuraFall();
      try {
        effectRef.current.initialize();
      } catch (error) {
        console.error("WebGL 2.0 initialization failed:", error);
        webgl2Unsupported = true;
        const canvas = document.getElementById("sakura-fall-canvas");
        const fallback = document.querySelector(".webgl-fallback");
        if (canvas) canvas.style.display = "none";
        if (fallback) (fallback as HTMLElement).style.display = "block";
        effectRef.current = null;
        return;
      }

      if (hasTargetFPS(effectRef.current)) {
        effectRef.current.targetFPS = recommendedFPS;
      }
    } else if (!shouldInitialize() && effectRef.current) {
      effectRef.current.cleanup();
      effectRef.current = null;
    }
  }

  // Setup effect lifecycle with shared utility
  setupEffectLifecycle({
    canvasId: "sakura-fall-canvas",
    initEffect: initSakuraFall,
    effectRef,
    typeGuards: {
      hasIsRunning,
      hasStartMethod,
      hasStopMethod,
    },
  });
</script>
